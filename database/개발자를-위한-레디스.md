# 개발자를 위한 레디스

## 레디스의 특징
* Remote Dictionary Server
* 레디스의 특징
  * In-Memory
  * 다양한 자료구조
  * 이벤트 루프 방식의 싱글 스레드
  * Sentinel을 통한 HA
  * 클러스터-샤드 기반의 확장성
  * 메모리는 영속적이지 않으나 AOF(Append Only File) RDB(Redis DataBase) 형식으로 디스크에 주기적으로 저장 가능
  * Message Broker

## 기본 개념
* string
  * SET
  * GET
  * INCR, INCRBY : Increment / DECR, DECRBY : Decrement
* NX, XX : 없으면 넣기, 있으면 덮어쓰기
* list : stack / queue 지원 명령어
* hash : key + item(field + value)
  * HGET, HMGET
  * HSET, HMSET
* set
* sorted set : score 값에 따라 정렬
  * 인덱스를 이용한 접근을 사용하는 경우가 있다면 List(O(n)) 보다 Sorted Set(O(log(n)))
* Geospatial
  * 경도 위도의 쌍의 집합
  * GEADD / GEOOPS
  * GEODIST : 아이템 간의 거리 조회
  * GEOSAERCH : 특정 위치 기준 거리 내 아이템 검색
    * BYRADIUS, BYBOX
* Key Managerment In Redis
  * 키가 존재하지 않을 때 삽입 > 빈 자료 구조를 자동으로 생성한 후 아이템 삽입
  * 모든 아이템 삭제 > 자동으로 키 삭제
  * 키가 없는 상태에서 읽기 전용 명령어 수행 > 아이템이 없는 것처럼 동작

## 레디스를 캐시로 쓰기
  * 읽기 전략 - Look aside
    * Application <> Redis
      * IF Cache Hit
        * Use Redis Cache
      * ELSE 
        * Load Origin Database 
    * Hit Rate가 높았다면, 캐시의 장애 시 모든 커넥션이 원본 데이터베이스로 몰려 추가적인 장애가 발생할 수 있다
    * 찾고자 하는 데이터가 레디스에 없을 때만 저장하기 때문에 Lazy Loading이라고도 부른다
    * 새로운 공연 정보가 데이터베이스에만 등록된다면 캐시 미스 과정이 많이 발생한다.
    * 이때, 캐시워밍(Cache Warming) 작업을 거치는 것이 효율적일 수 있다.
  * 쓰기 전략과 캐시 일관성
    * Write through
      * Database / Cache를 모두 업데이트한다.
      * 만료시간의 설정이 중요하다.
    * Cache Invalidation
      * DB Write 발생 > Cache Delete
      * 특정 데이터를 삭제하는 것이 새로운 데이터를 저장하는 것보다 리소스를 적게 사용한다.
    * Write Behind(Write Back)
      * 쓰기가 빈번하게 발생하는 서비스라면 우선 Cache에 적재하다가 > 특정 시점에 비동기적으로 Database 업데이트
    * TTL
      * 설정된 만료 시간이 지나면 레디스에서 자동으로 삭제된다.
      * 만료시간은 데이터를 조작해도 변경되지 않는다.
      * 기존 키에 새로운 값을 저장해 키를 덮어 쓸 때에는 설정한 만료시간은 사라진다.
      * 만료 키 삭제 방식
        * Passive 방식
          * 키에 접근할 때 만료 여부를 확인하고 삭제
          * 메모리는 차지하지만 실제로 접근하기 전까지는 삭제되지 않음
        * Active 방식
          * 백그라운드에서 주기적으로 만료된 키를 검사하고 삭제
          * 매 초마다 10번의 샘플링을 통해 만료된 키를 찾음
          * 샘플링된 키 중 25% 이상이 만료되었다면 다시 샘플링 진행
        * 레디스는 기본적으로 방식을 조합하여 사용
          * 메모리 효율성과 성능의 균형을 맞춤
      * 메모리 관리
        * Noeviction(기본 설정)
          * 메모리가 꽉 차면 추가 저장 시 에러 반환
          * 아주 위험한 설정
        * LRU
          * 가장 최근에 사용되지 않은 데이터부터 삭제
          * volatile-LRU
            * TTL이 있는 키만 삭제
          * allkeys-lru
            * 모든 키 삭제, 레디스 공식 문서에서는 "잘 모르겠으면, 이거 써라"
        * LFU
          * 가장 자주 사용되지 않는 데이터부터 삭제
          * LFU 옵션도 volatile, allkeys 존재
      * 캐시 스탬피드(cache stampede)
        * 캐시가 만료된 시점에 다수의 요청이 동시에 들어와
        * 모든 요청이 DB에 동시 접근하는 현상
        * "소떼가 몰려가는 것처럼" 동시에 DB에 부하가 집중됨
        * Cascading Failure
        * 적절한 만료시간 설정 / TTL이 임박한 캐시를 선계산하여 갱신하기
          * Probabilistic early recomputation(확률적 조기 재계산)
    * 세션 스토어로서의 레디스
      * Sticky Session : 특정 사용자의 요청을 항상 동일한 서버로 라우팅
      * 레디스 Hash 자료 구조로 세션을 저장하기 딱 좋다
      * 세션 스토어로서의 레디스는 데이터베이스의 서브셋이 아닌, 유일한 정보를 저장한다